<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Игры</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/blood.css" id="theme">
		<link rel="stylesheet" href="custom.css">
		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/blood.css" id="highlight-theme">
		<style>
			.left {
				float: left;
			}
			.right {
				float: right;
			}
			.clear {
				clear: both;
			}
			#game_matrix table td {
				border: 1px solid black;
				cursor: pointer;
				width: 70px;
				height: 70px;	
			}

			#game_matrix #name {
				width: 100%;
				height: 40px;
				line-height: 40px;
				font-size: 18px;
			}
			#game_matrix #find {
				width: 100%;
				height: 120px;
				line-height: 120px;
				border: 1px solid black;
			}
			#game_matrix #start {
				width: 100%;
				height: 40px;
				line-height: 40px;
				font-size: 18px;
				color: black;
				background-color: coral;
			}
			#score {
				font-size: 80%;
			}
			#table {
				overflow-y: scroll;
				height: 500px;
			} 

			.flex {
				display: flex;
			}

			#pingpong #field {
			width: 720px;
		}
		#pingpong #joystick {
			/* border: 1px solid black; */
			margin: 0 auto;
			width: 240px;
		}
		#pingpong input[type=range][orient=vertical] {
			appearance: slider-vertical;
			width: 100%;
			height: 540px;
			padding: 0 5px;
		}
		#pingpong #gamer {
			height: 40px;
			width: 300px;
			line-height: 40px;
			font-size: 19pt;
		}
		#pingpong #game_ping_pong_start {
			height: 40px;
			width: 300px;
			line-height: 40px;
			font-size: 19pt;
		}
			
		</style>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				
				<section data-markdown class="center">
					<script type="text/template">
						Игры
						=======
					</script>
				</section>
				
				<section data-markdown class="center">
					<script type="text/template">
						Игра - занятие, обусловленное совокупностью определенных правил, 
						приемов и служащее для заполнения досуга, развлечения.
					</script>
				</section>
				
				<section data-markdown class="center">
					<script type="text/template">
						## Компьютерная игра
					</script>
				</section>
				
				<section data-markdown class="center">
					<script type="text/template">
						### Компьютерная игра 
						1. Взаимодействие по определённому алгоритму (с целью развлечения, обучения, или тренировки) человека (группы людей) с компьютером или группы людей друг с другом посредством компьютера.

					</script>
				</section>
				
				<section data-markdown class="center">
					<script type="text/template">
						2. Компьютерная программа, которая организует игровой процесс и управляет им, 
						а также осуществляет взаимодействие между соперниками и партнерами по игре или сама выступает в качестве игрока. 
						В процессе игры на экране дисплея наглядно отображается игровая ситуация. Анализируя эту ситуацию, 
						играющий реагирует на неё с помощью устройств ввода (клавиатуры, мыши, джойстика и др.). 
						Ответные ходы или соответствующее изменение игровой ситуации компьютер воспроизводит на экране, 
						часто со звуковым сопровождением.
					</script>
				</section>
				
				<section data-markdown class="center">
					<script type="text/template">
						## Игра 1. Скоростная матрица
					</script>
				</section>
				
				<section data-markdown class="center">
					<script type="text/template">
						### Игра 1. Скоростная матрица
						Правила игры: игра состоит из 25 ячеек (5х5), ячейки раскрашены в 7 цветов: красный, зелёный, голубой, чёрный, белый, желтый и случайный цвет. 24 ячейки раскрашиваются в 6 разных цветов по 4 ячейки каждый. 1 ячейка уникального цвета. С интервалом 800мс ячейки будут перемешиваться. Нужно среди всех цветов отыскать ячейку с уникальным цветом и кликнуть на неё, пока ячейки снова не перемешались. 
					</script>
				</section>
				
				<section data-markdown class="center">
					<script type="text/template">
						### Игра 1. Скоростная матрица
						Начисление очков: за каждую правильно кликнутую ячейку игрок получает 1200 баллов + количество оставшихся миллисекунд до перемешивания матрицы. При ошибочном нажатии вычитается 1200 баллов + количество оставшихся миллисекунд до смены матрицы.
					</script>
				</section>
				
				<section data-markdown class="center">
					<script type="text/template">
						### Игра 1. Скоростная матрица
						Длительность раундов:
						1. 15 секунд
						2. 30 секунд
						3. 45 секунд
					</script>
				</section>
				
				<section id="game_matrix">
					<h3>Игра 1. Скоростная матрица</h3>
					<div id="wrapper">
						<div id="field" class="left"></div>
						<div id="info" class="right">
							<div>
								<input type="text" id="name" value="zxc">
								<div id="round"></div>
								<div id="time"></div>
								<div id="find">
									Цвет ячейки
								</div>
								<div id="score"></div>
								<div>
									<input type="button" id="start" value="Начать игру">
								</div>
							</div>
						</div>
						<div class="clear"></div>
					</div>
				</section>

				<section id="game_matrix_table">
					<h3>Турнирная таблица</h3>
					<div id="table"></div>
				</section>

				<section data-markdown class="center">
					<script type="text/template">
						## Игра 2. Пинг-понг
					</script>
				</section>

				<section data-markdown class="center">
					<script type="text/template">
						### Игра 2. Пинг-понг
						Правила игры: игровое поле разделено на две части. Слева и справа находятся движущиеся
						вверх и вниз ракетки игроков, которые отбивают шар по линейной траектории.
						В случае, если шар был отбит он меняет свою траекторию. Если шар улетел за пределы
						игрового поля, одно очко достается тому, кто отбил этот шар последним.
					</script>
				</section>

				<section data-markdown class="center">
					<script type="text/template">
						### Игра 2. Пинг-понг
						Начисление очков: 1 очко, выигравшему раундов
						
						Длительность: до первой ошибки игрока. Игра до 3 очков.
					</script>
				</section>

				<section>
					<h3>Игра 2. Пинг-понг</h3>
					<img src="kandinsky-download-1696001545627.png" alt="">
				</section>

				<section id="pingpong">
					<h3>Игра 2. Пинг-понг</h3>
					<div class="flex">
						<div id="field">
							<input type="name" id="gamer" value="renard" >
							<input type="button" id="game_ping_pong_start" value="Присоедениться к игре" >
							<canvas id="game_ping_pong" width="720" height="480"></canvas>
						</div>
						<div id="joystick">
							<input type="range" min="75" max="480" value="240" orient="vertical" disabled/>
						</div>
					</div>
				</section>

				<section data-markdown class="center">
					<script type="text/template">
						## Веселые картинки
					</script>
				</section>

				<section>
					<h3>Веселые картинки</h3>
					<img src="img/funny1.jpg" alt="">
					<img src="img/funny2.jpg" alt="">
					<img src="img/funny3.jpg" alt="">
				</section>

				<section
				data-background-image="img/funny2.jpg"
				data-menu-title="Смешная картинка">
				</section>

				<section data-markdown class="center">
					<script type="text/template">
						# Спасибо за внимание
					</script>
				</section>
		
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script src="https://game.9pr.ru/socket.io/socket.io.js"></script>
		<script src="pingpong/easel.js"></script>
		<script src="pingpong/Tween.js"></script>

		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,
				center: false,
				slideNumber: true,
				controls: true,
				dependencies :[
					{
						src: 'plugin/menu/menu.js'
					}
				],
				menu: {
					numbers: true,
					markers: true,
				},

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
			});
		</script>
		<script>

			class GameMatrix {
				constructor () {
					this.field = '';
					this.colors = [];
				}
				generateColors(colors) {
					let num = randomInteger(6);
					this.find = colors[num];
					for (let i = 0; i<7; i++) {
						this.colors = this.colors.concat(Array(i == num ? 1 : 4).fill(colors[i]));
					}
					console.log(this.colors);
					return this;
				}

				setFindColor (element) {
					element.style.backgroundColor = this.find;
					return this;
				}

				generateField () {
					this.field = `
						<table>
					`;
					for (let i = 0; i < 5; i++) {
						this.field += `<tr>`
							for (let j = 0; j < 5; j++) {
								this.field += `<td style="background: ${this.colors[i*5+j]}"></td>`
							}
						this.field += `</tr>`
					}
					this.field += `
						</table>
					`;
					return this;
				}

				fillField(element) {
					element.innerHTML = this.field;
					return this;
				}

				shuffleTd () {
					for (let i = this.colors.length -1; i>0; i--) {
						let j = Math.floor(Math.random()*(i+1));
						[this.colors[i],this.colors[j]]= 
						[this.colors[j],this.colors[i]];
					}
					return this;
				}
				
				updateField(tds) {
					for (let i=0;i< this.colors.length; i++) {
						tds[i].style.backgroundColor = this.colors[i];

					}

					return this;
				}
			}

			function randomInteger(max) {
				return Math.floor(Math.random()*(max + 1));
			}

			function randomRgbColor () {
				let r = randomInteger(255);
				let g = randomInteger(255);
				let b = randomInteger(255);
				return `rgb(${r}, ${g}, ${b})`;
			}

			let colors = [
				'rgb(255, 0, 0)',
				'rgb(0, 255, 0)',
				'rgb(0, 0, 255)',
				'rgb(255, 255, 0)',
				'rgb(255, 255, 255)',
				'rgb(34, 34, 34)',
			];
			
			colors.push(randomRgbColor());

			let timeScore = 0;
			const getScore = () => {
				socketMatrix = io('http://game.9pr.ru/matrix');
				socketMatrix.emit('getScore', (table) => {
					console.log(table);
					let scoreTable = `<table><thead><tr><th>Место</th><th>Ник</th><th>Баллы</th></tr></thead><tbody>`;
						for (let i in table) {
							scoreTable += `<tr><th>${+i+1}</th><th>${table[i].name}</th><th>${table[i].score}</th></tr>`;
						}
						scoreTable += `</tbody></table>`;
						document.querySelector('#game_matrix_table #table').innerHTML = scoreTable;
				});

			}

			let canvas;
	let stage;
	let container = new Container();
	let bgImg = new Image();
	let bg;
	let leftPlayerImg = new Image();
	let leftPlayer;
	let rightPlayerImg = new Image();
	let rightPlayer;
	let ballImg = new Image();
	let ball;
	let leftPlayerScore;
	let rightPlayerScore;
	let xSpeed = 5;
	let ySpeed = 5;
	let gfxLoaded = 0;
	let tkr = new Object;
	let x = 480*1.5;
	let y = 320*1.5;
	let ballSize = 30;
	let collisionX = 22;
	let collisionY = 75;
	let scoreTotal = 3;
	let side = 'right';
	function pingPongMain(element) {
		canvas = element;
		stage = new Stage(canvas);
		stage.mouseEventsEnabled = true;
		bgImg.src = 'pingpong/bg.png';
		bgImg.name = 'bg';
		bgImg.onload = loadGfx;
		leftPlayerImg.src = 'pingpong/paddle.png';
		leftPlayerImg.name = 'leftPlayer';
		leftPlayerImg.onload = loadGfx;
		ballImg.src = 'pingpong/ball.png';
		ballImg.name = 'ball';
		ballImg.onload = loadGfx;
		rightPlayerImg.src = 'pingpong/paddle.png';
		rightPlayerImg.name = 'rightPlayer';
		rightPlayerImg.onload = loadGfx;
		Ticker.setFPS(30);
		Ticker.addListener(stage);
		///////////////////////////
		socketPingPong = io("http://game.9pr.ru/pingpong");
		socketPingPong.on('connect', () => {
			socketPingPong.emit("createField", ''+Math.floor(Math.random()*9999999));
			socketPingPong.on("wait", (body) => {
				if (Object.keys(body.gamers).length == 1) {
					leftPlayerWait.online = true;
					side = 'left';
				}
				if (Object.keys(body.gamers).length == 2) {
					leftPlayerWait.online = true;
					rightPlayerWait.online = true;
				}
				waitGameStart();
			});
			socketPingPong.on("getY", (body) => {
				console.log(body);
				if (body.gamer !== document.querySelector('#gamer').value) {
					if (side === 'left') {
						rightPlayer.y = y - body.y;
					} else {
						leftPlayer.y = y - body.y;
					}
				}
			});
		});
		/////////////////////////////////////
	}
	function loadGfx(e) {
		if(e.target.name = 'bg'){bg = new Bitmap(bgImg);}
		if(e.target.name = 'leftPlayer'){leftPlayer = new Bitmap(leftPlayerImg);}
		if(e.target.name = 'ball'){ball = new Bitmap(ballImg);}
		if(e.target.name = 'rightPlayer'){rightPlayer = new Bitmap(rightPlayerImg);}
		gfxLoaded++;
		if(gfxLoaded == 4) {
			addGameView();
		}
	}
	function addGameView() {
		stage.addChild(bg, container);
		leftPlayer.x = 2;
		leftPlayer.y = y/2 - collisionY/2;
		rightPlayer.x = x - 25;
		rightPlayer.y = y/2 - collisionY/2;
		ball.x = x/2 - ballSize/2;
		ball.y = y/2 - ballSize/2;
		leftPlayerWait = new Text('Ожидание игрока', 'bold 28px Arial', '#A3FF24');
		leftPlayerWait.maxWidth = 1000;
		leftPlayerWait.x = 60;
		leftPlayerWait.y = y/3;
		leftPlayerWait.online = false;
		rightPlayerWait = new Text('Ожидание игрока', 'bold 28px Arial', '#A3FF24');
		rightPlayerWait.maxWidth = 1000;
		rightPlayerWait.x = x/2+60;
		rightPlayerWait.y = y/3;
		rightPlayerWait.online = false;
		leftPlayerScore = new Text('0', 'bold 28px Arial', '#A3FF24');
		leftPlayerScore.maxWidth = 1000;
		leftPlayerScore.x = x/2 - 30;
		leftPlayerScore.y = 30;
		rightPlayerScore = new Text('0', 'bold 28px Arial', '#A3FF24');
		rightPlayerScore.maxWidth = 1000;
		rightPlayerScore.x = x/2 + 10;
		rightPlayerScore.y = 30;
		stage.addChild(leftPlayerWait, rightPlayerWait, leftPlayerScore, rightPlayerScore, leftPlayer, rightPlayer, ball);
		stage.update();
	}
	




			window.onload = () => {

				pingPongMain(document.querySelector('#game_ping_pong'));
		document.querySelector('#game_ping_pong_start').onclick = () => {
			document.querySelector('#gamer').disabled = true;
			document.querySelector('#game_ping_pong_start').disabled = true;
			socketPingPong.emit('join', {
				gamer: document.querySelector('#gamer').value,
			}, (body) => {
				if (body.error !== undefined) {
					alert(body.error);
				}
			});
		};
		////################
		document.querySelector('#joystick input').addEventListener("input", movePaddle);
		////################
				let gameMatrix = new GameMatrix();
				if (sessionStorage.getItem('game_matrix_round') === null) {
					sessionStorage.setItem('game_matrix_round', 1);
				}
				document.querySelector('#game_matrix #round').innerHTML = `Раунд ${sessionStorage.getItem('game_matrix_round')}`;

				gameMatrix.generateColors(colors).setFindColor(document.querySelector('#game_matrix #find')).shuffleTd().generateField().fillField(document.querySelector('#game_matrix #field'));

				document.querySelector('#game_matrix #start').onclick = () => {
					if (document.querySelector('#game_matrix #name').value.trim() == '') {
						return alert('Введите Ваше имя');
					}
					
					const scoreCount = (e) => {
						console.log(e);
						if (gameMatrix.find === e.target.style.backgroundColor) {
							sessionStorage.setItem('game_matrix_score',
								+sessionStorage.getItem('game_matrix_score') + 1200 + timeScore

							);
						} else {
							sessionStorage.setItem('game_matrix_score',
								+sessionStorage.getItem('game_matrix_score') - 1200 - 800 + timeScore

							);
						}
						gameMatrix.shuffleTd().updateField(document.querySelectorAll('#game_matrix #field td'));
						clearInterval(interval);
						document.querySelector('#game_matrix #score').innerHTML = `Результат <br> ${sessionStorage.getItem('game_matrix_score')} баллов` ;
					}
					socket= io("http://game.9pr.ru/matrix");
					if (sessionStorage.getItem('game_matrix_score') == null) {
						sessionStorage.setItem('game_matrix_score', 0); 
					}
					document.querySelector('#game_matrix #score').innerHTML = `
					Результат <br> ${sessionStorage.getItem('game_matrix_score')} баллов
					`;
					const timeRound = [0, 5, 5, 5];
					let timeRemaind = timeRound[sessionStorage.getItem('game_matrix_round')]*1000;
					document.querySelector('#game_matrix #time').innerHTML = `
					Ост. время <br> ${sessionStorage.getItem('game_matrix_round')} с.
					`;
					timeScore = 800;
					let interval = setInterval (
						() => {
							
							if (timeRemaind <= 0) {
								clearInterval(interval);
							} else {
								gameMatrix.shuffleTd().updateField(document.querySelectorAll('#game_matrix #field td'));
							}
							
						}, 800
					);
					let time = setInterval (
						() => {
							timeRemaind -= 10;
							timeScore -= 10;
							if (timeRemaind <= 0) {
								clearInterval(time);
								document.querySelector('#game_matrix table').removeEventListener('click',scoreCount);
								document.querySelector('#game_matrix #start').style.display = 'block';
								document.querySelector('#game_matrix #time').innerHTML ='';
								if (sessionStorage.getItem('game_matrix_round') < 3) {
									sessionStorage.setItem('game_matrix_round', +sessionStorage.getItem('game_matrix_round')+1);
								}
								else {
									sessionStorage.setItem('game_matrix_round', 1);
									socket.emit('sendScore', {
										name: document.querySelector('#game_matrix #name').
										value.trim(),
										score: sessionStorage.getItem('game_matrix_score'),
									}
									);
									sessionStorage.setItem('game_matrix_score', 0);
									Reveal.next();
								}
								document.querySelector('#game_matrix #round').innerHTML = 'Раунд' + sessionStorage.getItem('game_matrix_round');
							} else {
								document.querySelector('#game_matrix #start').style.display = 'none';
								document.querySelector('#game_matrix #time').innerHTML = `
								Ост. время <br> ${timeRemaind/1000} с.
								`;
							}
						}, 10
					);

					if (sessionStorage.getItem('game_matrix_round') == 1) {
						sessionStorage.setItem('game_matrix_round', 0);
					}
					document.querySelector('#game_matrix table').addEventListener('click',scoreCount);
				}
				getScore();
				Reveal.on('slidechanged', (e) => {
					if (e.currentSlide.id == 'game_matrix_table') {
						getScore();
					}
				});
			}
		</script>
	</body>
</html>
